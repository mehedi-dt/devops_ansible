# - name: install aws codedeploy agent
#   shell: |
#     apt update
#     apt install ruby-full -y
#     cd /home/ubuntu

#     wget https://aws-codedeploy-{{ REGION | default('eu-west-2')}}.s3.{{ REGION | default('eu-west-2') }}.amazonaws.com/latest/install

#     chmod +x ./install
#     sudo ./install auto

#     systemctl restart codedeploy-agent
#     systemctl enable codedeploy-agent
#   register: codedeploy_output
#   args:
#     executable: /bin/bash

# - name: Show codedeploy install output
#   debug:
#     var: codedeploy_output.stdout_lines


- name: Install dependencies for the agent
  package:
    name:
      - ruby
      - wget
    state: present

- name: Download CodeDeploy installer
  get_url:
    url: https://aws-codedeploy-{{ REGION | default('eu-west-2')}}.s3.{{ REGION | default('eu-west-2') }}.amazonaws.com/latest/install
    dest: /tmp/install_codedeploy
    mode: '0755'

- name: Run CodeDeploy installer
  command: /tmp/install_codedeploy auto

- name: Ensure CodeDeploy agent is running
  service:
    name: codedeploy-agent
    state: started
    enabled: yes